# iOS ä½¿ç”¨ Lame è½¬ç  MP3 çš„æœ€æ­£ç¡®å§¿åŠ¿

## å‰è¨€

* æœ€è¿‘åœ¨é¡¹ç›®ä¸­, åšæœ‰å…³ **AVAudioRecorder** çš„å½•éŸ³å¼€å‘, éœ€è¦æŠŠå½•åˆ¶çš„æ ¼å¼è½¬æˆ MP3, é‡åˆ°äº†è½¬ç ä¹‹åŽçš„MP3æ–‡ä»¶, æ— æ³•èŽ·å–æ­£ç¡®çš„æ—¶é•¿é—®é¢˜. 
* ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜, çœŸçš„æ˜¯åå¤æ¥ä¿®æ”¹å½•éŸ³é…ç½®, æµªè´¹äº†ä¸çŸ¥é“å¤šå°‘çš„æ—¶é—´æ¥åˆ†æžè¿™ä¸ªé—®é¢˜. 
* ä¸­é—´æˆ‘åŽ»æŸæŸç¾¤åŽ»æ‰¾å¤§ç¥žæé—®é—®é¢˜,ç»“æžœé­åˆ°äº†é„™è§†, éƒ½ç»Ÿç»Ÿè´¨ç–‘æˆ‘çš„å½•éŸ³é…ç½®, æœ€åŽç”©ç»™æˆ‘ä¸€ä¸ªdemo, ç»“æžœæˆ‘ä¸€æµ‹è¯•, ä¹Ÿæ˜¯ä¸€æ ·çš„é—®é¢˜, æˆ‘å°±å‘µå‘µäº†.
* æ‰€ä»¥, æˆ‘ä»Šå¤©æ¥å†™ä¸€ç¯‡æ–‡ç« æ¥è®¤çœŸå‰–æžè¿™ä¸ªé—®é¢˜, ä¸ºä»€ä¹ˆèµ·å ? **iOS ä½¿ç”¨ Lame è½¬ç  MP3 çš„æœ€æ­£ç¡®å§¿åŠ¿ !** æ˜¯å› ä¸ºæˆ‘åœ¨ç™¾åº¦æœç´¢åˆ°çš„å„ç§æœ‰å…³äºŽ **Lame** è½¬ç çš„ä»£ç , è‡³å°‘å¾ˆå¤§ä¸€éƒ¨åˆ† éƒ½æ˜¯ä¸å®Œå…¨æ­£ç¡®çš„.
 
## æ¦‚è¿°

æˆ‘å°†ä¼šåœ¨æœ¬ç¯‡æ–‡ç« åˆ†æžä»¥ä¸‹å‡ ç‚¹å†…å®¹

* AVAudioRecorder é…ç½® å’Œ Lame ç¼–ç åŽ‹ç¼©é…ç½® 
* è§£å†³å½•éŸ³æ—¶é•¿è¯»å–ä¸æ­£ç¡®çš„é—®é¢˜
* è¾¹å½•åˆ¶è¾¹è½¬ç çš„å®žçŽ°
* æµ‹è¯• Demo

## AVAudioRecorder é…ç½® å’Œ Lame ç¼–ç åŽ‹ç¼©é…ç½®
### AVAudioRecorder é…ç½®çš„æ³¨æ„äº‹é¡¹


> å…³äºŽ AVAudioRecorder å½•éŸ³çš„ç›¸å…³é…ç½® å’Œ Lame åŒ…çš„ç¼–è¯‘å·¥ä½œ, è¿™é‡Œå¿½ç•¥ä¸è®², ä¸»è¦æ˜¯æƒ³è¯´ä¸€ä¸‹éœ€è¦æ³¨æ„çš„åœ°æ–¹

* Lame çš„è½¬ç åŽ‹ç¼©, æ˜¯æŠŠå½•åˆ¶çš„ PCM è½¬ç æˆ MP3, æ‰€ä»¥å½•åˆ¶çš„ `AVFormatIDKey` è®¾ç½®æˆ `kAudioFormatLinearPCM` , ç”Ÿæˆçš„æ–‡ä»¶å¯ä»¥æ˜¯ caf æˆ–è€… wav.
* [caf](http://baike.baidu.com/link?url=TsCl2mxLZvWORN0CnhwPqjxElPDDREWgTyVrIkxWHyoOjbtYnn2kSW2qaliPHSUCHNOyNFbjRGfKqwmkgn08WK) æ–‡ä»¶æ˜¯ Mac OS X åŽŸæœ¬æ”¯æŒçš„ä¼—å¤šéŸ³é¢‘æ ¼å¼ä¸­æœ€æ–°å¢žåŠ çš„ä¸€ç§. iPhone çŸ­ä¿¡å°±æ˜¯è¿™ç§æ ¼å¼, å½•åˆ¶å‡ºçš„æ–‡ä»¶ä¼šæ¯”è¾ƒå¤§.
* `AVNumberOfChannelsKey` å¿…é¡»è®¾ç½®ä¸ºåŒå£°é“, ä¸ç„¶è½¬ç ç”Ÿæˆçš„ MP3 ä¼šå£°éŸ³å°–é”å˜å£°.
* `AVSampleRateKey` å¿…é¡»ä¿è¯å’Œè½¬ç è®¾ç½®çš„ç›¸åŒ.

### Lame ç¼–ç åŽ‹ç¼© çš„ç›¸å…³é…ç½®

- æˆ‘ä»¬éœ€è¦å½•éŸ³æºæ–‡ä»¶è·¯å¾„å’Œç”ŸæˆMP3çš„è·¯å¾„ `FILE *pcm`  å’Œ `FILE *mp3`, 

```
//source è¢«è½¬æ¢çš„éŸ³é¢‘æ–‡ä»¶ä½ç½®
FILE *pcm = fopen([cafFilePath cStringUsingEncoding:1], "rb");  
//skip file header è·³è¿‡ PCM header èƒ½ä¿è¯å½•éŸ³çš„å¼€å¤´æ²¡æœ‰å™ªéŸ³ 
fseek(pcm, 4*1024,  SEEK_CUR); 
//output è¾“å‡ºç”Ÿæˆçš„Mp3æ–‡ä»¶ä½ç½®
FILE *mp3 = fopen([mp3FilePath cStringUsingEncoding:1], "wb+");  
```

* é€šè¿‡ `fopen` éœ€è¦æ³¨æ„æ‰“å¼€æ–‡ä»¶çš„æ¨¡å¼. ðŸ‘‡ æ˜¯æ‰©å±•çš„ çš„ C è¯­è¨€çš„ æ–‡ä»¶æ‰“å¼€æ¨¡å¼, ä¸ºä»€ä¹ˆè¦è¯´è¿™äº›, æ¯”å¦‚ æˆ‘ä½¿ç”¨ wb æ¥æ‰“å¼€ mp3, å°±æ„å‘³ç€æˆ‘åªå…è®¸å†™æ•°æ®, è€Œå¦‚æžœä½ æœ‰å¯¹æ–‡ä»¶çš„è¯»å–æ“ä½œ,å°†ä¼šå‡ºçŽ°é”™è¯¯, è¿™ä¹Ÿæ˜¯æˆ‘è¢«å‘è¿‡çš„åœ°æ–¹. 
              
```
C è¯­è¨€çš„ æ–‡ä»¶æ‰“å¼€æ¨¡å¼

w+ä»¥çº¯æ–‡æœ¬æ–¹å¼è¯»å†™ï¼Œè€Œwb+æ˜¯ä»¥äºŒè¿›åˆ¶æ–¹å¼è¿›è¡Œè¯»å†™ã€‚
modeè¯´æ˜Žï¼š
w æ‰“å¼€åªå†™æ–‡ä»¶ï¼Œè‹¥æ–‡ä»¶å­˜åœ¨åˆ™æ–‡ä»¶é•¿åº¦æ¸…ä¸º0ï¼Œå³è¯¥æ–‡ä»¶å†…å®¹ä¼šæ¶ˆå¤±ã€‚è‹¥æ–‡ä»¶ä¸å­˜åœ¨åˆ™å»ºç«‹è¯¥æ–‡ä»¶ã€‚
w+ æ‰“å¼€å¯è¯»å†™æ–‡ä»¶ï¼Œè‹¥æ–‡ä»¶å­˜åœ¨åˆ™æ–‡ä»¶é•¿åº¦æ¸…ä¸ºé›¶ï¼Œå³è¯¥æ–‡ä»¶å†…å®¹ä¼šæ¶ˆå¤±ã€‚è‹¥æ–‡ä»¶ä¸å­˜åœ¨åˆ™å»ºç«‹è¯¥æ–‡ä»¶ã€‚
wb åªå†™æ–¹å¼æ‰“å¼€æˆ–æ–°å»ºä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œåªå…è®¸å†™æ•°æ®ã€‚
wb+ è¯»å†™æ–¹å¼æ‰“å¼€æˆ–å»ºç«‹ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå…è®¸è¯»å’Œå†™ã€‚
r æ‰“å¼€åªè¯»æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å¿…é¡»å­˜åœ¨ï¼Œå¦åˆ™æŠ¥é”™ã€‚
r+ æ‰“å¼€å¯è¯»å†™çš„æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å¿…é¡»å­˜åœ¨ï¼Œå¦åˆ™æŠ¥é”™ã€‚
rb+ è¯»å†™æ–¹å¼æ‰“å¼€ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œåªå…è®¸è¯»å†™æ•°æ®ã€‚
a ä»¥é™„åŠ çš„æ–¹å¼æ‰“å¼€åªå†™æ–‡ä»¶ã€‚è‹¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™ä¼šå»ºç«‹è¯¥æ–‡ä»¶ï¼Œå¦‚æžœæ–‡ä»¶å­˜åœ¨ï¼Œå†™å…¥çš„æ•°æ®ä¼šè¢«åŠ åˆ°æ–‡ä»¶å°¾ï¼Œå³æ–‡ä»¶åŽŸå…ˆçš„å†…å®¹ä¼šè¢«ä¿ç•™ã€‚ï¼ˆEOFç¬¦ä¿ç•™ï¼‰
a+ ä»¥é™„åŠ æ–¹å¼æ‰“å¼€å¯è¯»å†™çš„æ–‡ä»¶ã€‚è‹¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™ä¼šå»ºç«‹è¯¥æ–‡ä»¶ï¼Œå¦‚æžœæ–‡ä»¶å­˜åœ¨ï¼Œå†™å…¥çš„æ•°æ®ä¼šè¢«åŠ åˆ°æ–‡ä»¶å°¾åŽï¼Œå³æ–‡ä»¶åŽŸå…ˆçš„å†…å®¹ä¼šè¢«ä¿ç•™ã€‚ ï¼ˆåŽŸæ¥çš„EOFç¬¦ä¸ä¿ç•™ï¼‰
ab+ è¯»å†™æ‰“å¼€ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå…è®¸è¯»æˆ–åœ¨æ–‡ä»¶æœ«è¿½åŠ æ•°æ®ã€‚
åŠ å…¥b å­—ç¬¦ç”¨æ¥å‘Šè¯‰å‡½æ•°åº“æ‰“å¼€çš„æ–‡ä»¶ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè€Œéžçº¯æ–‡å­—æ–‡ä»¶ã€‚
```

* ç„¶åŽæ˜¯ `lame_init()` æ¥åˆå§‹åŒ–, ` lame_set_num_channels(lame,1)` é»˜è®¤è½¬ç ä¸º2åŒé€šé“, è®¾ç½®å•å£°é“ä¼šæ›´å¤§ç¨‹åº¦å‡å°‘åŽ‹ç¼©åŽæ–‡ä»¶çš„ä½“ç§¯.
* æŽ¥ä¸‹æ¥ æ˜¯æ‰§è¡Œä¸€ä¸ª do while çš„å¾ªçŽ¯æ¥åå¤è¯»å– `FILE* stream ` , ç›´åˆ° read != 0 , ç»“æŸè½¬ç ,é‡Šæ”¾  `lame_close(lame); fclose(mp3);  fclose(pcm);`

## è§£å†³å½•éŸ³æ—¶é•¿è¯»å–ä¸æ­£ç¡®çš„é—®é¢˜

> Lame çš„è½¬ç é…ç½®ç½‘ä¸Šæœ‰å¾ˆå¤š, ç½‘ä¸Šå¯ä»¥æœåˆ°å¾ˆå¤šç›¸å…³çš„ä»£ç , ä½œä¸ºå°ç™½ copy ä½¿ç”¨, ç”±äºŽä¸æ‡‚æºç å®žçŽ°,ç›´æŽ¥æ‹¿æ¥ç”¨å°±å‡ºçŽ°äº†ä¸å¯é¢„æ–™çš„é—®é¢˜. æˆ‘å‡ºçŽ°çš„æ’­æ”¾æ—¶é—´ä¸å‡†ç¡®çš„é—®é¢˜, æ— è®ºæ˜¯ AVPlayer æˆ–è€… AVAudioPlayer å‡æ— æ³•è¯»å–æ­£ç¡®çš„é•¿åº¦, è¦ä¹ˆæ˜¯å¤šå‡ ç§’, è¦ä¹ˆæ˜¯å°‘å‡ ç§’, è¿˜å¯èƒ½æ˜¯è¶…è¿‡10sçš„çš„è¯¯å·®, ä½†æ˜¯æ’­æ”¾çš„è¿‡ç¨‹ä¸­, å®šæ—¶å™¨çš„è®¡æ•° ä¼šå’Œ æ€»æ—¶é—´æ˜¾ç¤ºä¸å»åˆ, å°±æ¯”å¦‚ ä¸€ä¸ªæ˜¾ç¤º 2:30 çš„å½•éŸ³, æ´»ç”Ÿç”Ÿ æ”¾åˆ°äº† 2:50, ä½ èƒ½æƒ³è±¡æ˜¯å¤šä¹ˆçš„å°´å°¬Bug.

### é—®é¢˜çŒœæµ‹

**æˆ‘æŠŠå½•åˆ¶å®Œæˆçš„æ–‡ä»¶, ä½¿ç”¨ iTunes æ¥æ’­æ”¾å¯ä»¥æ˜¾ç¤ºå‡ºæ­£ç¡®çš„é•¿åº¦, ä½†æ˜¯ä½¿ç”¨ QuickTime Player ä¼šå‡ºçŽ°å’Œ AVPlayer ä¸€æ ·çš„é”™è¯¯æ—¶é•¿ !!!**

- æ‰€ä»¥åˆ†æžé€ æˆè¿™ä¸ªé—®é¢˜çš„åŽŸå› å¯èƒ½æ˜¯: 
 *  1. AVPlayer ä¸èƒ½æ­£ç¡®è¯»å–é•¿åº¦
 *  2. MP3çš„ç¼–ç å‡ºçŽ°äº†é”™è¯¯...

- ç„¶åŽç½‘ä¸Šä¹Ÿæœ‰äººé‡åˆ°äº†åŒæ ·çš„é—®é¢˜,ç»™å‡ºçš„è§£å†³æ–¹æ³•æ˜¯æ¢ä¸€ç§ AVPlayer è¯»å–æ–¹æ³•:
æˆ‘æ€»ç»“äº† AVPlayer èŽ·å–æ€»æ—¶é•¿çš„ä»¥ä¸‹æ–¹æ³• ,ç»“æžœæµ‹è¯• ç»“æžœéƒ½æ˜¯ç›¸è¿‘, 

* way 1

```   
 CMTime time = _player.currentItem.duration;
    if (time.timescale == 0) {
        return 0;
    }
    return time.value / time.timescale;
```
    
* way 2

```
    if (self.player && self.player.currentItem && self.player.currentItem.asset) {
        return  CMTimeGetSeconds(self.player.currentItem.asset.duration);

    } else{
        return 0;
    }
    
```

* way 3
 
```
    AVURLAsset* audioAsset = [AVURLAsset URLAssetWithURL:self.playingURL options:nil];
    CMTime audioDuration = audioAsset.duration;
    float audioDurationSeconds = CMTimeGetSeconds(audioDuration);
    return (NSInteger)audioDurationSeconds;
```

- å…¶ä¸­ , ä½¿ç”¨ [Asset](http://blog.csdn.net/qingyuan159/article/details/53085302) å¯ä»¥è§£å†³èŽ·å–æ€»æ—¶é—´æ˜¯ NA çš„è¿™ç§é”™è¯¯æƒ…å†µ. å®žé™…ä¸­æˆ‘å¹¶æ²¡æœ‰å‡ºçŽ°è¿‡.
- æˆ‘çš„æµ‹è¯•ä¸­ AVPlayer ä½¿ç”¨è¿™å‡ ä¸ªæ–¹æ³•, å‡æ— æ³•å¾—åˆ°æ­£ç¡®çš„å€¼, æ‰€ä»¥åº”è¯¥å°±æ˜¯ç”Ÿæˆæ–‡ä»¶çš„é—®é¢˜äº†.

### äº†è§£MP3ç¼–ç æ ¼å¼

ç„¶åŽ,é€šè¿‡å¯¹[MP3ç¼–ç æ ¼å¼](http://blog.csdn.net/xiahouzuoxin/article/details/7860631)è°ƒç ”, äº†è§£åˆ°å¦‚ä¸‹ä¿¡æ¯:

* MP3ä½¿ç”¨çš„æ˜¯åŠ¨æ€ç çŽ‡æ–¹å¼ï¼Œè€Œè¿™ç§æ–¹å¼æ¯ä¸€å¸§çš„é•¿åº¦åº”è¯¥æ˜¯ä¸ç­‰çš„ã€‚é‚£ä¼šä¸ä¼šæ˜¯ **AVPlayer** æ˜¯æŠŠæ–‡ä»¶å½“åšæ¯å¸§ç›¸ç­‰çš„æ–¹å¼æ¥è®¡ç®—çš„æ€»æ—¶é—´ï¼Œæ‰€ä»¥æ‰ä¸å¯¹ï¼Ÿ
* ä¸æ–­è¾“å‡º AVPlayer durationæ¥çœ‹, æ¯æ¬¡éƒ½ä¼šæœ‰ä¸åŒçš„ç»“æžœ, è€Œ AVPlayer æ˜¯æ”¯æŒMp3 VBRæ ¼å¼æ–‡ä»¶æ’­æ”¾çš„ã€‚æ‰€ä»¥åº”è¯¥è¿˜æ˜¯æˆ‘ä»¬çš„ç”Ÿæˆçš„æ–‡ä»¶æœ‰é—®é¢˜
* äº†è§£åˆ° MP3 VBRå¤´è¿™ä¸ªä¸œè¥¿,æœ‰å®ƒè®°å½•äº†æ•´ä¸ªæ–‡ä»¶çš„å¸§æ€»æ•°é‡ï¼Œå°±èƒ½ç›´æŽ¥ç®—å‡ºduration.æ‰€ä»¥æ˜¯ä¸æ˜¯æˆ‘ä»¬Lameç¼–ç çš„æ—¶å€™,æ²¡æœ‰å†™å…¥ VBR å¤´ å‘¢.

### Lame æºç åˆ†æž


* æœç´¢ Lame æºç  **VBR**å…³é”®å­—å¯ä»¥å¾—åˆ°

```
/*
  1 = write a Xing VBR header frame.
  default = 1
  this variable must have been added by a Hungarian notation Windows programmer :-)
*/
int CDECL lame_set_bWriteVbrTag(lame_global_flags *, int);
int CDECL lame_get_bWriteVbrTag(const lame_global_flags *);
```

* æºç å†™çš„å¾ˆç®€å•, å°±æ˜¯è®¾ç½®äº† `gfp->write_lame_tag`å€¼, çœ‹çœ‹æ‰€æœ‰è°ƒç”¨ `write_lame_tag` çš„åœ°æ–¹å§ã€‚ç¬¬ä¸€ä¸ªå°±æ‰¾åˆ°äº†`lame_encode_mp3_frame(..)`å‡½æ•°ã€‚è¿™ä¸å°±æ˜¯ç”¨æ¥æ¯æ¬¡çŒbufferç»™lameåšMP3ç¼–ç çš„æ–¹æ³•å˜›ï¼ä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡éƒ½ä¼šç»™ç»™å¸§æ·»åŠ VBRä¿¡æ¯ï¼Œè¿™å’Œä¹‹å‰çœ‹çš„ç¼–ç èµ„æ–™æè¿°çš„ä¸€æ ·ã€‚

* æŽ¥ä¸‹æ¥, å°±æ˜¯éœ€è¦æ‰¾åˆ°å†™å…¥VBRå¤´çš„å‡½æ•°, æœç´¢æºç å¯å¾— `PutLameVBR()` è¢«è°ƒç”¨åœ¨`lame_get_lametag_frame()`å‡½æ•°é‡Œ, ç„¶åŽæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªå‡½æ•°:


```
/*
 * OPTIONAL:
 * lame_mp3_tags_fid will rewrite a Xing VBR tag to the mp3 file with file
 * pointer fid.  These calls perform forward and backwards seeks, so make
 * sure fid is a real file.  Make sure lame_encode_flush has been called,
 * and all mp3 data has been written to the file before calling this
 * function.
 * NOTE:
 * if VBR  tags are turned off by the user, or turned off by LAME because
 * the output is not a regular file, this call does nothing
 * NOTE:
 * LAME wants to read from the file to skip an optional ID3v2 tag, so
 * make sure you opened the file for writing and reading.
 * NOTE:
 * You can call lame_get_lametag_frame instead, if you want to insert
 * the lametag yourself.
*/
void CDECL lame_mp3_tags_fid(lame_global_flags *, FILE* fid);
```

* åŽŸæ¥è¿™ä¸ªå‡½æ•°æ˜¯åº”è¯¥åœ¨lame_encode_flush()ä¹‹åŽè°ƒ, å½“æ‰€æœ‰æ•°æ®éƒ½å†™å…¥å®Œæ¯•äº†å†è°ƒç”¨ã€‚ä»”ç»†æƒ³æƒ³ä¹Ÿå¾ˆåˆç†, è¿™æ—¶æ‰èƒ½ç¡®å®šæ–‡ä»¶çš„æ€»å¸§æ•°ã€‚

### é—®é¢˜è§£å†³

* çŽ°åœ¨çš„æ€è·¯å°±æ¯”è¾ƒæ¸…æ™°äº†, ç”±äºŽåœ¨Lameç¼–ç çš„è¿‡ç¨‹ä¸­, æˆ‘ä»¬æ²¡æœ‰å¯¹VBRå¤´è¿›è¡Œå†™å…¥, å¯¼è‡´äº† AVPlayer duration ä»¥æ¯å¸§ç›¸åŒçš„æ–¹å¼æ¥è®¡ç®—å‡ºçŽ°çš„é”™è¯¯.
* è§£å†³æ–¹æ³•æ˜¯, åœ¨lameæ–‡ä»¶å…¨éƒ¨å†™å…¥ä¹‹åŽ, lameé‡Šæ”¾ä¹‹å‰, ä½¿ç”¨ `lame_mp3_tags_fid` å†™å…¥ VBR å¤´æ–‡ä»¶, æµ‹è¯•é€šè¿‡, è¯»å–æ—¶é—´æ­£å¸¸.
* è€Œè¿™è¡Œä»£ç  `lame_mp3_tags_fid` æˆ‘åœ¨ ç½‘ä¸Šæœç´¢çš„å„ç§é…ç½®ä¸­å‘çŽ°éƒ½æ²¡æœ‰å†™.

## è¾¹å½•åˆ¶è¾¹è½¬ç çš„å®žçŽ°

> é€šå¸¸æˆ‘ä»¬æ˜¯åœ¨å½•åˆ¶ç»“æŸä¹‹åŽ, å†è¿›è¡Œè½¬ç ; å½“å½•åˆ¶çš„æ—¶é—´è¾ƒé•¿, ä¼šæ¶ˆè€—çš„æ—¶é—´æ¯”è¾ƒé•¿. ç”¨æˆ·éœ€è¦ç­‰å¾…è½¬ç ç»“æŸåŽ,æ‰èƒ½æ“ä½œ; ä½†æ˜¯å¦‚æžœæˆ‘ä»¬ä½¿ç”¨è¾¹å½•åˆ¶,è¾¹è½¬ç çš„æ–¹å¼, å¼€å¦å¤–ä¸€ä¸ªçº¿ç¨‹åŒæ—¶è¿›è¡Œè½¬ç ,åˆ™å‡ ä¹Žæ²¡æœ‰ç­‰å¾…çš„æ—¶é—´,æ•ˆçŽ‡ä¸Šä¼šæ¯”è¾ƒçš„é«˜.
    
    
* æ ¸å¿ƒä»£ç å®žçŽ°
    
```
            do {
                curpos = ftell(pcm);
                long startPos = ftell(pcm);
                fseek(pcm, 0, SEEK_END);
                long endPos = ftell(pcm);
                long length = endPos - startPos;
                fseek(pcm, curpos, SEEK_SET);
                
                if (length > PCM_SIZE * 2 * sizeof(short int)) {
                    
                    if (!isSkipPCMHeader) {
                        //Uump audio file header, If you do not skip file header
                        //you will heard some noise at the beginning!!!
                        fseek(pcm, 4 * 1024, SEEK_CUR);
                        isSkipPCMHeader = YES;
                        NSLog(@"skip pcm file header !!!!!!!!!!");
                    }
                    
                    read = (int)fread(pcm_buffer, 2 * sizeof(short int), PCM_SIZE, pcm);
                    write = lame_encode_buffer_interleaved(lame, pcm_buffer, read, mp3_buffer, MP3_SIZE);
                    fwrite(mp3_buffer, write, 1, mp3);
                    NSLog(@"read %d bytes", write);
                } else {
                    [NSThread sleepForTimeInterval:0.05];
                    NSLog(@"sleep");
                }
                
            } while (! weakself.stopRecord);
```

* è¾¹å½•è¾¹è½¬ç , åªæ˜¯æˆ‘ä»¬åœ¨å½•åˆ¶ç»“æžœåŽ,é‡æ–°å¼€ä¸€ä¸ªçº¿ç¨‹æ¥è¿›è¡Œæ–‡ä»¶çš„è½¬ç , 
* å½“å½•éŸ³è¿›è¡Œä¸­æ—¶, ä¼šæŒç»­è¯»å–åˆ°æŒ‡å®šå¤§å°æ–‡ä»¶,è¿›è¡Œç¼–ç , è¯»å–ä¸åˆ°,åˆ™çº¿ç¨‹ä¼‘çœ 
* åœ¨ while çš„æ¡ä»¶ä¸­, æˆ‘ä»¬æ”¶åˆ° å½•éŸ³ç»“æŸçš„æ¡ä»¶,åˆ™ä¼šç»“æŸ do while çš„å¾ªçŽ¯.
* æˆ‘ä»¬éœ€è¦åœ¨å½•åˆ¶ç»“æŸåŽå‘é€ä¸€ä¸ªä¿¡å·, è®© do while è·³å‡ºå¾ªçŽ¯

## æµ‹è¯• Demo
    
> ä¸ºäº†è®©é‡åˆ°ç›¸åŒé—®é¢˜çš„äºº, èƒ½å¤Ÿæ›´åŠ å¯¹è¿™äº›é—®é¢˜æœ‰ä¸€ç‚¹çš„äº†è§£, æˆ‘ä¼š åœ¨è¿™é‡Œè´´ä¸€ä¸ªæˆ‘æµ‹è¯•çš„Demo è¿™åªæ˜¯ä¸€ä¸ªå®žä¾‹ç¨‹åº, å¹¶ä¸å…·å¤‡å®Œæ•´çš„é€»è¾‘åŠŸèƒ½, è¯·ç†ŸçŸ¥.

- å…³äºŽDemo, å¯ä»¥åœ¨ ViewController ä¸­ `#define ENCODE_MP3 1` ä½¿ç”¨ 1 å’Œ 0 , æ¥æµ‹è¯•æ™®é€šè½¬ç  å’Œ è¾¹å½•åˆ¶ è¾¹è½¬ç .
- `ConvertAudioFile` æ˜¯å½•éŸ³è½¬ç å°è£…çš„æºç  
- è¾¹å½•è¾¹è½¬çš„ç”¨æ³• 

```
        [[ConvertAudioFile sharedInstance] conventToMp3WithCafFilePath:self.cafPath
                                                           mp3FilePath:self.mp3Path
                                                            sampleRate:ETRECORD_RATE callback:^(BOOL result)
        {
            NSLog(@"---- è½¬ç å®Œæˆ  --- result %d  ---- ", result);
        }];;
        
``` 

- å½•åˆ¶å®Œæˆè½¬ç çš„ç”¨æ³•

```
    [ConvertAudioFile conventToMp3WithCafFilePath:self.cafPath
                      mp3FilePath:self.mp3Path
                       sampleRate:ETRECORD_RATE callback:^(BOOL result)
     {
         NSLog(@"---- è½¬ç å®Œæˆ  --- result %d  ---- ", result);
     }];
        
```

- Demo è§ æ–‡ç« åº•éƒ¨, å¦‚æžœDemo æœ‰ä»€ä¹ˆä¸ç†è§£ å’Œ ä¸å‡†ç¡®çš„åœ°æ–¹,è¿˜éº»çƒ¦æŒ‡æ­£...

## ç»“è¯­

> ç”±äºŽæ—¶é—´æœ‰é™, æˆ‘å¹¶ä¸ä¼š å†™å¤ªå¤šç»†è‡´çš„å†…å®¹, åªæ˜¯å¯¹è¿™å‡ å¤©çš„ç ”ç©¶åšä¸€ä¸ªæ€»ç»“,å’Œåˆ—ä¸¾ä¸€äº›æ³¨æ„äº‹é¡¹,å¦‚æžœåœ¨åšéŸ³é¢‘å½•åˆ¶è½¬ç ä¸­é‡åˆ°ç›¸åŒçš„é—®é¢˜,åˆ™ä¼šæœ‰æ¯”è¾ƒå¤§çš„å¸®åŠ©.

### æ€»ç»“

è¿™æ¬¡è§£å†³è¿™ä¸ªé—®é¢˜,è®©æˆ‘å—ç›ŠåŒªæµ…, å¾ˆå¤šåœ°æ–¹çš„æ”¶èŽ·æ˜¯è¶…è¿‡é—®é¢˜æœ¬èº«çš„:

* åœ¨ä½¿ç”¨åˆ«äººçš„ç¤ºèŒƒä»£ç æ—¶,å¦‚æžœä¸è¿›è¡Œä¸€å®šçš„å‰–æž;å½“å‡ºçŽ°é—®é¢˜çš„æ—¶é—´,ä¼šæ¯”è¾ƒçš„éš¾åˆ¤æ–­é—®é¢˜çš„æ¥æº
* iOSçš„ç›¸å…³æŠ€æœ¯åšå®¢,çŽ°åœ¨ç½‘ä¸Šå¯ä»¥æœåˆ°å¾ˆå¤šç›¸å…³ç¤ºèŒƒä»£ç , ä½†æ˜¯ç”±äºŽå¾ˆå¤šäººå¯èƒ½ä¹Ÿæ˜¯è´´å‡ºäº†å¹¶ä¸æ˜¯å¾ˆå‡†ç¡®çš„ä¸œè¥¿, ç›¸å…³ç»™åˆ«äººå¸¦æ¥äº†é”™è¯¯çš„ç¤ºèŒƒ.
* ä½œä¸º iOS å¼€å‘è€…, å¯¹å¾ˆå¤šä¸œè¥¿,å¦‚æžœæƒ³è¦æœ‰æ›´åŠ æ·±å±‚æ¬¡çš„ç†è§£,åˆ™éœ€è¦ 1. è®¡ç®—æœºåŸºç¡€æ‰Žå®ž 2. iOSåº•å±‚ç†è§£å¤Ÿæ·± 3.æž¶æž„è®¾è®¡æ¨¡å¼ç†è§£å¤Ÿæ·± 4.ä»£ç å¹³æ—¶å†™çš„å¿…é¡»å¤Ÿä¼˜é›… 
* Google ä¼šæ¯” Baidu é è°±å‘€; è™½ç„¶æˆ‘ä¹‹å‰ä¹Ÿæ˜¯è¿™ä¹ˆæƒ³çš„,ä½†è¿™æ¬¡å¯¹æˆ‘æœ‰å¸®åŠ©çš„æ–‡ç« å‡æ¥è‡ª Google, ç›¸åBaidu ç»™äº†å¾ˆå¤šé”™è¯¯çš„ç¤ºèŒƒ.

### Link

* [Demo - GitHub](https://github.com/CivelXu/iOS-Lame-Audio-transcoding.git)
* [ç®€ä¹¦](http://www.jianshu.com/p/971fff236881)
* [ä¸ªäººåšå®¢](http://civelxu.com/2016/07/04/iOS%20ä½¿ç”¨%20Lame%20è½¬ç %20MP3%20çš„æœ€æ­£ç¡®å§¿åŠ¿/)

### è‡´è°¢

> å¯¹æˆ‘æœ‰å¸®åŠ©çš„æ–‡ç« 

* https://itony.me/365.html
* http://www.jianshu.com/p/57f38f075ba0




